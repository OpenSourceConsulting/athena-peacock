<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="UserMapper">

	<sql id="getUserListBase">
		SELECT 
			a.user_id
		    ,a.login_id
		    ,a.user_name
		    ,a.dept_name
		    ,a.email
		    ,a.last_logon
		    ,a.reg_user_id as regUserId
		    ,a.reg_dt as regDt
		    ,a.upd_user_id as updUserId
		    ,a.upd_dt as updDt
		FROM users_tbl a
		<where>
			<if test="search != null">
			a.user_name LIKE concat('%',#{search},'%')
			</if>
		</where>
		LIMIT #{start}, #{limit} 
	</sql>

	<select id="getUserList" resultType="com.athena.peacock.controller.web.user.UserDto" parameterType="ExtjsGridParam">
		<include refid="getUserListBase"/>
	</select>
	
	<select id="getUserListTotalCount" resultType="int" parameterType="ExtjsGridParam">
		SELECT COUNT(*)
		FROM (
			<include refid="getUserListBase"/>
		) AS T
	</select>

	<insert id="insertUser" parameterType="com.athena.peacock.controller.web.user.UserDto">
		<selectKey keyProperty="user_id" resultType="int" order="BEFORE">SELECT IFNULL(MAX(user_id),0)+1 FROM users_tbl</selectKey>
		INSERT INTO 
			users_tbl
		(
			user_id
		    ,login_id
		    ,hashed_passwd
		    ,user_name
		    ,dept_name
		    ,email
		    ,reg_user_id
		    ,reg_dt
		    ,upd_user_id
		    ,upd_dt
		)
		VALUES (
			#{user_id}
			,#{login_id}
			,password(#{passwd})
			,#{user_name}
			,#{dept_name}
			,#{email}
			,#{regUserId}
			,NOW()
			,#{updUserId}
			,NOW()
		)
		
	</insert>

	<select id="getUser" parameterType="int" resultType="com.athena.peacock.controller.web.user.UserDto">
		SELECT 
			user_id
		    ,login_id
		    ,user_name
		    ,dept_name
		    ,email
		    ,last_logon
		    ,reg_user_id
		    ,reg_dt
		    ,upd_user_id
		    ,upd_dt
		FROM users_tbl
		WHERE 
			user_id = #{userId}
	</select>
	
	<update id="updateUser" parameterType="com.athena.peacock.controller.web.user.UserDto">
		UPDATE 
			users_tbl
		SET
			login_id = #{login_id}
			,hashed_passwd = password(#{passwd})
			,user_name = #{user_name}
			,dept_name = #{dept_name}
			,email = #{email}
			,upd_user_id = #{updUserId}
			,upd_dt = NOW()
		WHERE
			user_id = #{user_id}
	</update>
	
	<update id="updateLastLogon" parameterType="int">
		UPDATE 
			users_tbl
		SET
			last_logon = NOW()
		WHERE
			user_id = #{user_id}
	</update>
	
	<delete id="deleteUser" parameterType="int">
		DELETE FROM 
			users_tbl
		WHERE
			user_id = #{user_id}
	</delete>
	
	<select id="getLoginUser" parameterType="com.athena.peacock.controller.web.user.UserDto" resultType="com.athena.peacock.controller.web.user.UserDto">
		SELECT 
			user_id
		    ,login_id
		    ,user_name
		    ,dept_name
		    ,email
		    ,last_logon
		    ,reg_user_id
		    ,reg_dt
		    ,upd_user_id
		    ,upd_dt
		FROM users_tbl
		WHERE 
			login_id = #{login_id}
			AND hashed_passwd = password(#{passwd})
	</select>

</mapper>
